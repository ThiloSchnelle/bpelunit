<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="coverage-report" name="org.bpelunit.toolsupport">
	<property file="build.ant.properties" />

	<property name="dir.bin.test" location="bin-tests" />
	<property name="dir.bin.instrumented" location="bin-instrumented/" />
	<property name="dir.bin" location="bin-ant/" />
	<property name="dir.build.lib" location="build.lib" />
	<property name="dir.report.junit" location="report-junit/" />
	<property name="dir.report.coverage" value="report-coverage/" />
	<property name="dir.src" location="src" />

	<path id="project.classpath">
		<pathelement location="bin" />
		<fileset dir="${dir.bpelunit.framework}/lib">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="build.lib">
			<include name="**/*.jar" />
		</fileset>
		<pathelement location="${ECLIPSE_HOME}/plugins/org.junit4_4.3.1/junit.jar" />
	</path>

	<path id="cobertura.classpath">
		<pathelement location="build.lib/cobertura.jar" />
	</path>

	<taskdef classpath="build.lib/cobertura.jar:build.lib/asm-3.0.jar:build.lib/asm-tree-3.0.jar:build.lib/jakarta-oro-2.0.8.jar:build.lib/log4j-1.2.9.jar" resource="tasks.properties" />

	<target name="init">
		<mkdir dir="${dir.bin}" />
		<mkdir dir="${dir.report.coverage}" />
		<mkdir dir="${dir.bin.instrumented}" />
		<mkdir dir="${dir.bin.test}" />
		<mkdir dir="${dir.report.junit}" />
	</target>

	<target name="build" depends="init" description="compiles everything">
		<javac encoding="utf-8" srcdir="${dir.src}" destdir="${dir.bin}" debug="yes">
			<include name="org/bpelunit/toolsupport/util/schema/**/*.java" />
			<exclude name="**/*Test.java" />
			<exclude name="**/AllTests.java" />
			<exclude name="**/*Dummy*" />
			<classpath refid="project.classpath" />
		</javac>
	</target>

	<target name="build-tests" depends="build">
		<javac encoding="utf-8" srcdir="${dir.src}" destdir="${dir.bin.test}" debug="yes">
			<include name="org/bpelunit/toolsupport/util/schema/**/*Test.java" />
			<include name="org/bpelunit/toolsupport/util/schema/**/AllTests.java" />
			<include name="org/bpelunit/toolsupport/util/schema/**/*Dummy*" />
			<classpath refid="project.classpath" />
			<classpath location="${build.dir}" />
		</javac>
	</target>

	<target name="instrument" depends="build-tests, clean.instrumented">
		<cobertura-instrument todir="${dir.bin.instrumented}">
			<fileset dir="${dir.bin}">
				<include name="org/bpelunit/toolsupport/util/schema/**/*.class" />
				<exclude name="**/*Test.class" />
				<exclude name="**/AllTests.class" />
				<exclude name="**/*Dummy*" />
			</fileset>
		</cobertura-instrument>
	</target>

	<target name="test" description="führt alle Junit-Tests aus." depends="clean.junit, build,instrument">
		<junit errorproperty="test.failed" failureproperty="test.failed">
			<classpath path="${dir.bin.instrumented}" />
			<classpath path="${dir.bin}" />
			<classpath path="${dir.bin.test}" />
			<classpath refid="project.classpath" />
			<classpath refid="cobertura.classpath" />

			<formatter type="brief" usefile="no" />
			<formatter type="xml" />
			<batchtest todir="${dir.report.junit}" fork="yes">
				<fileset dir="${dir.bin.test}" includes="**/*Test.class" />
			</batchtest>
		</junit>

		<junitreport todir="${dir.report.junit}">
			<fileset dir="${dir.report.junit}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="frames" todir="${dir.report.junit}" />
		</junitreport>
	</target>

	<target name="coverage-report" description="Erzeugt den Report über die Testabdeckung." depends="test">
		<cobertura-report format="html" srcdir="${dir.src}" destdir="${dir.report.coverage}" />
	</target>

	<target name="clean.junit">
		<delete dir="${dir.bin.test}" />
		<delete>
			<fileset dir=".">
				<include name="TEST-*" />
			</fileset>
		</delete>
		<delete dir="${dir.report.junit}" />
	</target>

	<target name="clean.instrumented">
		<delete dir="${dir.bin.instrumented}" />
		<delete file="cobertura.ser" />
	</target>

	<target name="AttributeImplTest">

		<mkdir dir="${junit.output.dir}" />
		<junit fork="yes" printsummary="withOutAndErr">
			<classpath refid="project.classpath" />
			<formatter type="xml" />
			<test name="org.bpelunit.toolsupport.util.schema.nodes.impl.AttributeImplTest" todir="${junit.output.dir}" />
		</junit>
	</target>

</project>
