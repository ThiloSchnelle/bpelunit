 
  \subsection{Aktivitätabdeckung}
  Zu betonen ist, dass es  bei der Messung der Testabdeckung nicht darum geht, ob die Aktivität \textit{erfolgreich} ausgeführt wurde, sondern lediglich darum, ob es zur Ausführung der Aktivität kommt. Die Marken, die die Ausführung der Basisaktivitäten signalisieren sollen, werden im Kontrollfluß direkt vor der jeweiligen Aktivität platziert. Bei der \textit{receive}-Aktivität wird die Marke ausnahmsweise erst nach der Aktivität eingefügt. Die Ausführung dieser Aktivität findet erst statt, wenn sie die Kontrolle hat und eine Nachricht von außen ankommt. Bei diesem Verhalten darf die Ausführung der Aktivität erst nach dem Eintreffen einer Nachricht registriert werden. 
  
  Befindet sich eine Basisaktivität in einer sequence, so kann die zugehörige Marke direkt davor oder danach eingefügt werden. Die Semantik der sequence-Aktivität sorgt dafür, dass die Marken im Kontrollfluß direkt hintereinander erreicht werden können. Ist eine Basisaktivität in einer anderen strukturierten Aktivität eingebettet, so wird eine sequence eingefügt, die diese Aktivität und die zugehörige Marke umschließt. Durch das Schachtelungsprinzip der strukturierten Aktivitäten ist diese Vorgehensweise an jeder Stelle des Prozesses möglich.
  
  Das Link-Konzept, wie bereits angekündigt, braucht eine  besondere Betrachtung. 
  Innerhalb der Flow-Aktivitäten ermöglicht das Link-Konzept die Syn\-chro\-ni\-sa\-tions\-ab\-hän\-gig\-keit\-en zwischen den Aktivitäten zu definieren und durch die darauf aufbauenden Bedingungen die Ausführung der Aktivitäten zu steuern. Befindet sich eine eingefügte Marke im Kontrollfluss direkt vor oder nach der Aktivität, so besteht die Gefahr, dass die Ausführung der Aktivitäten falsch erfasst wird:
\begin{itemize}
	\item Protokollierung findet vor der Aktivität statt und die Aktivität  selbst wird aufgrund der \textit{transition-} oder \textit{join condition} nicht ausgeführt.
	\item Protokollierung findet nach der Aktivität statt, die Aktivität selbst wird aufgrund der \textit{transition-} oder \textit{join condition} nicht ausgeführt und das Attribut \textit{suppress join} ist mit dem Wert \textit{"`yes"'} belegt.
\end{itemize}
In den beiden Fällen wird die Ausführung einer Aktivität registriert, obwohl die Aktivität gar nicht ausgeführt wurde.

Um zu erreichen, dass die Aktivität und das Logging (beide) entweder ausgeführt oder nicht ausgeführt werden, muss die Synchronisation und damit das Link sich auf beide beziehen. Zu beachten ist, dass ein Link genau eine \textit{target}- und eine \textit{source}-Aktivität verbinden kann. Damit ist es nicht möglich, dasselbe Link für die Aktivität selbst und für die Protokollierung zu verwenden.  Schließt man die zu protokollierende Aktivität und die Loggingaktivität in eine \textit{sequence} ein und definiert diese als Ziel des Links, so ist das gewünschte Verhalten erreicht, ohne die Geschäftslogik zu beeinflussen.  Das gilt für beide Werte des \textit{suppress join}-Attributes. 
Die Definition und die Quelle des Links (\textit{source}-Aktivität) bleiben unverändert. Die Abbildung \ref{fig:Listing2Designer} stellt die Manipulation grafisch dar.
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.8\textwidth]{bilder/ActivityIsTarget.png}
	\label{fig:Listing2Designer}
\end{figure}

Listing \ref{Listing1} zeigt beispielhaft die entsprechenden Änderungen des Quellcodes.
\setlength{\columnsep}{1cm}
\begin{multicols}{2}
\lstset{emph={joinCondition,target }, emphstyle=\color{blue}}
      \begin{lstlisting}[caption=\textit{Invoke}-Aktivität als Ziel\\ eines Links,numbers=none,label=Listing1]{Name}
<flow>

	 ...
  <invoke ... joinCondition=...>
    <target linkName="LinkA"/>
  </invoke>  
  
  
</flow>    
  \end{lstlisting}
\lstset{emph={[2]sequence}, emphstyle=[2]\color{red}}
      \begin{lstlisting}[numbers=none]{Name}
      
      
<flow>
	 ...
  <sequence joinCondition=...>
    <target linkName="LinkA"/>
    <!--Logging-->
    <invoke .../>
    <!--Logging-->
  </sequence>
</flow>      \end{lstlisting}
\end{multicols}

\subsection{Zweigabdeckung}
Die strukturierten Aktivitäten bestimmen in BPEL den Kontrollfluss und spielen damit eine entscheidende Rolle für die Ermittlung der Zweigabdeckung. Die einzelnen Zweige werden nämlich bei der Analyse der strukturierten Aktivitäten des Prozesses identifiziert. Die Protokollierung der Zweigen erfolgt im Wesentlichen nach dem Schema, das für die Erfassung der Aktivitätsabdeckung vorgestellt wurde. An den entsprechenden Stellen in der BPEL-Datei werden Marken eingefügt, die das Aktivieren der entsprechenden Zweigen markieren. Damit die Datei bei diesen Manipulationen syntaktisch gültig bleibt, wird ebenfalls 
eine umschließende sequence-Aktivität eingefügt. 

Ausführlicher werden einige strukturierten Aktivitäten vorgestellt, die im Bezug auf die Zweigabdeckung einige Besonderheiten aufweisen.

\textbf{\textit{If}-Aktivität.}
Es muss bei diesem Konstrukt darauf geachtet werden, dass der \textit{else}-Zweig erfasst wird. Ist der Zweig nicht explizit im Quellcode vorhanden, dann muss er hinzugefügt und wie alle anderen Zweige annotiert werden.

\textbf{\textit{Flow}-Aktivität.}
\begin{wrapfigure}[7]{r}{7,5cm}
\centering%
\includegraphics[width=0.45\textwidth]{bilder/FlowCreateInstance.png}%
\label{}
\end{wrapfigure}
Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.............Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics[width=0.5\textwidth]{bilder/FlowCreateInstance.png}
%	\label{fig:createInstanceProblem}
%\end{figure}


\begin{wrapfigure}[12]{r}{7,5cm}
\centering%
\includegraphics[width=0.48\textwidth]{bilder/FlowCreateInstance2.png}%
\label{}
\end{wrapfigure}
Fügt man zusätzliche Aktivitäten, die die Aktivierung des zweiten Zweigs melden sollen, vor dem Synchronisationslink ein, so kann dieser Prozess nicht ausgeführt werden. Der Grund dafür ist: dadurch, dass die eingefügten Aktivitäten nicht durch das Link synchronisiert sind, können diese bereits vor der receive-Aktivität (bzw. gleichzeitig mit der receive-Aktivität)  ausgeführt werden. In jedem BPEL-Prozess muss vor der Ausführung einer Basisaktivität (ausgenommen receive-Aktivitäten mit dem Attribut createInstance=yes) eine receive- oder pick-Aktivität ausgeführt werden, die eine Prozessinstanz erzeugen können. Diese Forderung wird in dem Beispiel nicht erfüllt...........Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.............Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.

\newpage
 %\begin{figure}[htbp]
	%\centering
	%	\includegraphics[width=0.5\textwidth]{bilder/FlowCreateInstance2.png}
	%\label{fig:createInstanceProblem}
%\end{figure}
\begin{wrapfigure}[12]{r}{7,5cm}
\centering%
\includegraphics[width=0.48\textwidth]{bilder/FlowCreateInstance3.png}%
\label{}
\end{wrapfigure} 
 Werden die eingefügten Links ebenfalls mit der receive-Aktivität synchronisiert, so tritt dieses Problem nicht auf. Dadurch wird sichergestellt, dass ein Zweig nur dann als "`abgedeckt"' gilt, wenn die Zielaktivität dieses Zweigs zur Ausführung kommt. Die entsprechende Lösung ist in der Abbildung \ref{} vorgestellt. ....Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.............Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.
 %\begin{figure}[htbp]
%	\centering
%		\includegraphics[width=0.5\textwidth]{bilder/FlowCreateInstance3.png}
%	\label{fig:createInstanceProblem}
%\end{figure}
 
 \textbf{\textit{RepeatUntil}-Aktivität.}
 Die Auswertung der Bedingung erfolgt in dieser Wiederholungsschleife erst nach der Ausführung des Schleifenkörpers. Bei der Ausführung der Aktivität in der Schleife kann man ohne weiteren Logik nicht feststellen, ob es die erste Ausführung ist oder wiederholte. Ist das eine wiederholte Ausführung, so muss die Aktivierung des Zweigs von der Bedingung zur Aktivität signalisiert werde. 
 Die entsprechende Überprüfung kann mit Hilfe eines Zählers, der bei jedem Schleifendurchlauf hochgezählt wird, und einer if-Abfrage realisiert werden. Eine neue Variable einfügen ............. und vor der Schleif initialisieren...........
 \begin{figure}[htbp]
	\centering
		\includegraphics[width=0.65\textwidth]{bilder/repeatUntilZweig.png}
	\label{}
\end{figure}
\FloatBarrier 
\subsection{Link Abdeckung}
Es geht bei dieser Metrik um Links mit einer \textit{transition condition}, die nicht mit einem konstante Wert \textit{true} oder \textit{false} belegt ist.  Das Link-Konzept von BPEL ist sehr mächtig und komplex. Durch  \textit{transition} und \textit{join condition} und das Attribut \textit{suppressJoin}  können komplizierten Bedingungen aufgestellt und damit der Kontrollfluß beeinflusst. Die BPEL-Spezifikation definiert die Auswertung dieser Bedingungen genau. Das Ziel diser Metrik ist, den Tester dazu zu bewegen, dass die \textit{transition condition} während der Tests mindestens einmal auf \textit{true} und einmal auf \textit{false} gesetzt wird. 

Für die Erfassung dieser Werte während der Ausführung werden ebenfalls Links verwendet. Folgende Aspekte müssen bei der Realisierung beachtete werden:
\begin{itemize}
	\item boundary-crossing Restriktionen
	\item unterschiedliche Wertebelegung des \textit{suppress join}-Attributs und daraus resultierendes Verhalten beim Auftreten von \textit{Join Failure}
	\item \textit{Dead-Path-Elimination}
\end{itemize} 

\textbf{Beispiel}. Als Grundlage für die Erläuterungen dient folgendes Szenario. Ein Unternehmen  hat einige Strategien entwickelt, um die Großkunden trotz großer Konkurenz an sich langfristig zu binden. Als besonderen Service wird zum Beispiel bei Bestellungen dieser Kunden eine bestimmte Lieferdauer garantiert. Aus diesem Grund ist man zum Beispiel bereit, die Engpässe auf dem Lager für die Großkunden durch Bestellungen bei Konkurenz zu überbrücken und auf diese Weise kurzfristig sogar Verluste in Kauf zu nehmen. Der Geschäftsprozess wird entsprechend der Strategie angepasst und in den IT-Systemen (durch BPEL) umgesetzt. Ein vereinfachter Ausschnitt des zugehörigen BPEL-Prozesses ist in der Abbildung \ref{fig:FlowBeispielDesigner} grafisch Dargestellt.
\begin{wrapfigure}[9]{r}{7,5cm}
\centering%
\includegraphics[width=0.48\textwidth]{bilder/FlowBeispiel.png}%
\label{}
\end{wrapfigure} 
Es gibt zwei Web Services \textit{Kundenidentifikation} und \textit{Externe Bestellung}, die von BPEL in dem Prozess aufgerufen werden.   Die dafür zuständigen invoke-Aktivitäten sind in einer flow-Umgebung eingebettet. Die if-Abfrage stellt sicher, dass externe Unternehmen nur dann beauftragt werden, wenn die Ware nicht im Lager vorhanden ist. Da die externe Bestellungen nur bei Großkunden in Frage kommen, muss erst der Kunde identifiziert werden. Die entsprechende Reihenfolge der Web Service-Aufrufe wird durch das Synchronisationslink \textit{LinkA} gesichert. Die \textit{transition condition} des Links \textit{customerType}=\textit{'major'} sichert, dass nur die Großkunden diesen Service genießen können.  


%\begin{figure}[htbp]
%	\centering
%		\includegraphics[width=0.5\textwidth]{bilder/FlowBeispiel.png}
%	\label{fig:FlowBeispielDesigner}
%\end{figure}
%\vspace{1cm}

Die Erfassung des Status jedes relevanten Links ist für die Ermittlung der Linkabdeckung notwendig. Anhängig von dem Wert der \textit{transition condition} muss während der Ausführung die Marke an den \textit{Markers Receiver} verschickt werden, die auf den Wert der \textit{transition condition} zurückschließen lässt.  Als mögliche Lösungen werden drei Ansätze mit ihren Vor- und Nachteilen vorgestellt und anschließend eine ausgewählt.

\underline{Variante 1.}\\
Zwei zusätzliche Links werden definiert (\textit{LinkACopy} und \textit{LinkACopyNegiert}). Dabei übernimmt der \textit{LinkACopyNegiert} die negierte  \textit{transition condition} des Originallinks (\textit{customerType}=\textit{not('major')}) und  der \textit{LinkACopy} die unveränderte (\textit{customerType}=\textit{'major'}). Die Logging-Anweisungen werden bei diesem Ansatz direkt in der flow-Umgebung platziert. 
  Dadurch sind sie bereit für die Ausführung, sobald der Kontrollfluss die flow-Aktivität erreicht. Die source- und target-Aktivitäten des Originallinks können dabei beliebig tief in strukturierte Aktivitäten eingebettet sein. Durch die am Anfang definierten Links, wird die \textit{source}-Aktivität des Originallinks mit den Logging-Anweisungen verlinkt. Für eine Logging-Anweisung ein Link. Sobald der Status der Links bekannt ist, wird eine Logging-Anweisung ausgeführt.

Die \textit{Default-join condition} der Logging-Aktivitäten (\textit{or}-Verknüpfung der Status aller eingehenden Links) und komplementären \textit{transition conditions} der beiden neuen Links garantieren, dass nur eine Loggingaktivität gleichzeitig ausgeführt werden kann.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz1.png}
%	\label{fig:LinksAnsatz1}
%\end{figure}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/FlowBeispielV1.png}
	\label{fig:LinksAnsatz1Designer}
\end{figure}


\begin{table}[h!]
\begin{tabular}{p{6cm}p{0.5cm}p{6cm}}
\textbf{Vorteile}&\ &\textbf{Nachteile}\\[0.1cm]
\hline \\
Logging kann stattfinden, unabhängig davon, ob Activity2 ausgeführt wird&\ &\textit{boundary-crossing}-Restriktionen können verletzt werden\\
\end{tabular}
%\caption{Vergleich der Ansätze}
\label{Vergleichstabelle}
\end{table} 
\FloatBarrier
Die Variante ermöglicht den Linkstatus unabhängig von dem Aufruf des Web Services \textit{Externe Bestellung} zu erfassen. Das heißt, der Linkstatus wird auch dann erfasst, wenn die Bedingung \textit{holding}$>$\textit{orderSize} zu false ausgewertet wird und der Zweig mit Web Service \textit{Externe Bestellung} nicht aktiviert wird. Damit wird die formale Definition der Metrik umgesetzt.

Allerdings funktioniert diese Vorgehensweise nicht in allen Situationen. Die Bearbeitung mehrerer Aufträge von verschiedenen Kunden kann in BPEL mittels einer Schleife umgesetzt werden. Die invoke-Aktivität \textit{Kundenidentifikation} und die komplette if-Aktivität können in die Schleife eingebettet werden, um die Bestellungen auf die gleiche Weise nacheinander zu bearbeiten. In dieser Situation würde die Instrumentierung der BPEL-Datei nach dem vorgestelltem Verfahren die Syntaxregeln der BPEL-Sprache verletzen: ein Link darf die Grenzen einer Schleife nicht schneiden (\textit{boundary crossing}-Restriktionen aus Abschnitt \ref{}).  

\underline{Variante 2.}\\
Ziel dieses Ansatzes ist, die \textit{boundary-crossing}-Restriktionen einzuhalten. Die Konstruktion der Links \textit{LinkACopy} und \textit{LinkACopyNegiert} erfolgt auf dieselbe Weise.
Bei dieser Variante wird die target-Aktivität des Links (invoke-Aktivität \textit{Externe Bestellung}) mit den beiden Loggingaktivitäten in eine flow-Aktivität eingeschlossen.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz2.png}
%	\label{fig:LinksAnsatz2}
%\end{figure}
\begin{figure}
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/FlowBeispielV2.png}
	\label{fig:LinksAnsatz2Designer}
\end{figure}


\begin{table}[h!]
\begin{tabular}{p{6cm}p{0.5cm}p{6cm}}
\textbf{Vorteile}&\ &\textbf{Nachteile}\\[0.1cm]
\hline \\
\textit{boundary-crossing}-Restriktionen werden eingehalten&\ &Die Links können nur dann geloggt werden, wenn die Activity2 ausgeführt werden kann
\\
\end{tabular}
%\caption{Vergleich der Ansätze}
\label{Vergleichstabelle}
\end{table}
Bei diesem Verfahren schneiden das Originallink und die neu eingefügten Links dieselben Grenzen der strukturierten Aktivitäten.
Setzt man eine syntaktisch gültige Ausgangs-BPEL-Datei voraus, so werden keine boundary crossing-Restriktionen verletzt, denn die Grenzen der eingefügten flow-Aktivität dürfen durch die Links geschnitten werden.

Wird die Bedingung \textit{holding}>\textit{orderSize} zu false ausgewertet, so können die Loggingaktivitäten nicht ausgeführt werden. Der Linkstatus kann in dieser Situation nicht erreicht werden.
\FloatBarrier
\underline{Variante3.}\\
Bei dieser Variante wird die source-Aktivität des Links (\textit{Kundenidentifikation}) durch eine \textit{flow}-Umgebung umschlossen. Einerseits sorgt die Platzierung der Logging-Anweisungen in derselben \textit{flow}-Umgebung für die Einhaltung der \textit{boundary-crossing}-Restriktionen. Andererseits kann das Logging auch stattfinden, wenn die Zielaktivität nicht ausgeführt wird. Da der Status der Links nach der Ausführung der Quellaktivität gesetzt wird, sind die Logging-Aktivitäten zu diesem Zeitpunkt startbereit und können gleich die entsprechenden Marken an den Markers Receiver Service verschicken.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz3.png}
%	\label{fig:LinksAnsatz3}
%\end{figure}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/FlowBeispielV3.png}
	\label{fig:LinksAnsatz3Designer}
\end{figure}

Während die ersten beiden Varianten keine korrekte Messung der Linkabdeckung in allen Situationen ermöglichen, gewährleistet das dritte Verfahren eine korrekte Erfassung des Linkstatus und ist damit für die Ermittlung der Linkabdeckung geeignet.
Als Lösung für die Abdeckungsmessung der Links eignet sich diese Variante am Besten. 
\FloatBarrier
\subsection{Fault und Compensation Handler}
Für die Fault und Compensation Handler werden die Marken auf dieselbe Weise (mit Hilfe einer umschließenden sequence-Aktivität) in den catch und catchAll-Blöcken bzw. in Compensation Handler platziert. Vor der Platzierung der Marken müssen allerdings die so genannten inline-Handler durch explizite Scopes mit expliziten Fault und Compensation Hanler ersetzt werden (siehe Abbildung \ref{}).
 
\subsection{Realisierung der Kommunikation mit Web Service}
Mit Hilfe von Invoke-Aktivitäten kann ein BPEL-Prozess mit einem Web Service kommunizieren. Die invoke-Aktivität hat folgende Attributen:
\begin{itemize}
	\item \textbf{partnerLink} enthält des Partner Links. 
\item \textbf{portType} gibt WSDL-Porttype des Zielservices an.
\item \textbf{operation} gibt die WSDL-Operation an.
\item \textbf{inputVariable} gibt Variable an, die die zu sendenden Daten enthält.
\item \textbf{outputVariable} gibt Variable an, die die Antwort des Services speichert.
\end{itemize}

Soll eine asynchrone Kommunikation realisiert werden oder eine Operation aufgerufen werden, die keine Rückgabedaten erzeugt, so wird der Attribut \textit{outputVariable} weggelassen. Die Listing \ref{} zeigt eine invoke-Aktivität, die die Marken an den Service transportiert.

Zuvor muss die Variable .. natürlich deklariert werden. Damit die Variable im ganzen Prozess benutzt werden kann, wird sie als globale Variable (im \textit{variables}-Element des Prozesses) definiert. Zur Vermeidung der Namenskonflikten werden kryptische namen generiert.

Bild...

Die Zuordnung der Marken erfolgt mit Hilfe einer assign-Aktivität(siehe Listing \ref{} ).

Bild... 
   
Da in BPEL durch flow-Aktivität die nebenläufige Ausführung der Aktivitäten möglich ist,    
 Variable für jeden parallelen Zweig
\section{Auswertung der Daten und Ermittlung der Metriken}
Beim Instrumentieren des BPEL-Prozesses werden Marken generiert, die die entsprechenden Aspekte des Kontrollflusses eindeutig identifizieren und zu einer bestimmten Metrik gehören. Alle Marken, die in den Kontrollfluß eingefügt wurden, werden gespeichert und stehen während und nach der Ausführung des Prozesses zur Verfügung.
Während der BPEL-Prozess zum Testen ausgeführt wird, werden die Marken an den Web Service gesendet. 
Die empfangenen Marken liegen auf dem Ausführungspfad und wurden damit durch die Tests abgedeckt. 
Anhand der bei der Instrumentierung gespeicherten und während der Ausführung gesammelten Daten können die Statistiken ermittelt werden. Dabei gibt es die Möglichkeit sowohl die Statistik einer ganzen Testsuite als auch der einzelnen Testcases zu ermitteln.