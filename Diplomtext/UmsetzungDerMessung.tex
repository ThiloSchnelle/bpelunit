 
  \subsection{Aktivitätabdeckung}
  Zu betonen ist, dass es  bei der Messung der Testabdeckung nicht darum geht, ob die Aktivität \textit{erfolgreich} ausgeführt wurde, sondern lediglich darum, ob es zur Ausführung der Aktivität kommt. Die Marken, die die Ausführung der Basisaktivitäten signalisieren sollen, werden im Kontrollfluß direkt vor der jeweiligen Aktivität platziert. Die Ausnahmen sind receive-Aktivitäten, die durch Aufrufe von außen aktiviert werden.   
  
  Befindet sich eine Basisaktivität in einer sequence, so kann die zugehörige Marke direkt davor oder danach eingefügt. Die Semantik der sequence-Aktivität sorgt dafür, dass die Marken im Kontrollfluß direkt hintereinander erreicht werden können. Ist eine Basisaktivität in einer anderen strukturierten Aktivität eingebettet, so wird eine sequence eingefügt, die diese Aktivität und die zugehörige Marke umschließt. Durch das Schachtelungsprinzip der strukturierten Aktivitäten ist diese Vorgehensweise an jeder Stelle des Prozesses möglich.
  
  Das Link-Konzept, wie bereits angekündigt, braucht eine  besondere Betrachtung. 
  Innerhalb der Flow-Aktivitäten ermöglicht das Link-Konzept die Syn\-chro\-ni\-sa\-tions\-ab\-hän\-gig\-keit\-en zwischen den Aktivitäten zu definieren und durch die darauf aufbauenden Bedingungen die Ausführung der Aktivitäten zu steuern. Befindet sich eine eingefügte Marke im Kontrollfluss direkt vor oder nach der Aktivität, so ist es möglich, dass die Ausführungen falsch erfasst werden. Ist \textit{die zu protokollierende Aktivität Ziel eines oder mehreren Links}, so führen folgende Konstellationen zu falschen Aussagen:
\begin{itemize}
	\item Protokollierung findet vor der Aktivität statt und die Aktivität wird aufgrund der \textit{transition-} oder \textit{joinCondition} nicht ausgeführt.
	\item Protokollierung findet nach der Aktivität statt, die Aktivität wird aufgrund der \textit{transition-} oder \textit{joinCondition} nicht ausgeführt und die Variable suppressJoin ist mit dem Wert \textit{yes} belegt.
\end{itemize}
In den beiden Fällen wird die Ausführung einer Aktivität registriert, obwohl die Aktivität gar nicht ausgeführt wurde.

Um zu erreichen, dass die Aktivität und das Logging (beide) entweder ausgeführt oder nicht ausgeführt werden, muss der Link sich auf beide beziehen. Schließt man die zu protokollierende Aktivität und die Logginganweisung in eine \textit{sequence} ein und definiert diese als Ziel des Links (durch \textit{target}-Element), so ist das gewünschte Verhalten erreicht. Das gilt für beide Werte der \textit{suppressJoin}-Varaible. 
Das ursprüngliche \textit{target}-Element muss entfernt werden. Die Definition und die Quelle des Links bleiben unverändert. In Listing \ref{Listing1} werden die entsprechenden Änderungen des Quellcodes an einem Beispielauschnitt dargestellt.
%\setlength{\columnsep}{1cm}
%\begin{multicols}{2}
%\lstset{emph={joinCondition,target }, emphstyle=\color{blue}}
%      \begin{lstlisting}[caption=\textit{Invoke}-Aktivität als Ziel\\ eines Links,numbers=none,label=Listing1]{Name}
%<flow>
%
%	 ...
%  <invoke ... joinCondition=...>
%    <target linkName="CtoD"/>
%  </invoke>  
%  
%  
%</flow>    
%  \end{lstlisting}
%\lstset{emph={[2]sequence}, emphstyle=[2]\color{red}}
%      \begin{lstlisting}[numbers=none]{Name}
%      
%      
%<flow>
%	 ...
%  <sequence joinCondition=...>
%    <target linkName="CtoD"/>
%    <!--Logging-->
%    <invoke .../>
%    <!--Logging-->
%  </sequence>
%</flow>      \end{lstlisting}
%\end{multicols}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.7\textwidth]{bilder/Listing2Designer.png}
	\label{fig:Listing2Designer}
\end{figure}

\subsection{Zweigabdeckung}
Die strukturierten Aktivitäten bestimmen in BPEL den Kontrollfluss und spielen damit eine entscheidende Rolle für die Ermittlung der Zweigabdeckung. Die einzelnen Zweige werden nämlich bei der Analyse der strukturierten Aktivitäten des Prozesses identifiziert. Die Registrierung der Zweigen erfolgt im Wesentlichen nach dem Schema, das für die Erfassung der Aktivitätsabdeckung vorgestellt wurde. An den entsprechenden Stellen in der BPEL-Datei werden Marken eingefügt, die das Aktivieren der entsprechenden Kanten markieren. Damit die Datei bei diesen Manipulationen syntaktisch gültig bleibt, wird 
eine umschließende sequence-Aktivität eingefügt. 

Ausführlicher werden einige strukturierten Aktivitäten vorgestellt, die im Bezug auf die Zweigabdeckung die eine oder die andere Besonderheit aufweisen.

\textbf{\textit{If}-Aktivität.}
Es muss bei diesem Konstrukt darauf geachtet werden, dass der \textit{else}-Zweig erfasst wird. Ist der Zweig nicht explizit im Quellcode vorhanden, dann muss er hinzugefügt und wie alle anderen Zweige annotiert werden.

\textbf{\textit{Flow}-Aktivität.}
Innerhalb der Flow-Aktivität können Synchronisationslinks definiert werden. Die Abbildung \ref{} zeigt anhand eines kleinen Beispiels, wieso im Zusammenhang mit der Zweigabdeckung eine Rolle spielen.

Bild...

 Fügt man zusätzliche Aktivitäten, die die Aktivierung des zweiten Zweigs melden sollen, vor dem Synchronisationslink ein, so kann dieser Prozess nicht ausgeführt werden. Der Grund dafür ist: dadurch, dass die eingefügten Aktivitäten nicht durch das Link synchronisiert sind, können diese bereits vor der receive-Aktivität (bzw. gleichzeitig mit der receive-Aktivität)  ausgeführt werden. In jedem BPEL-Prozess muss vor der Ausführung einer Basisaktivität (ausgenommen receive-Aktivitäten mit dem Attribut createInstance=yes) eine receive- oder pick-Aktivität ausgeführt werden, die eine Prozessinstanz erzeugen können. Diese Forderung wird in dem Beispiel nicht erfüllt.
 
 Werden die eingefügten Links ebenfalls mit der receive-Aktivität synchronisiert, so tritt dieses Problem nicht auf. Dadurch wird sichergestellt, dass ein Zweig nur dann als "`abgedeckt"' gilt, wenn die Zielaktivität dieses Zweigs zur Ausführung kommt. Die entsprechende Lösung ist in der Abbildung \ref{} vorgestellt. 
 
 Bild..
 
 \textbf{\textit{RepeatUntil}-Aktivität.} Für die Bestimmung des zweiten Zweiges Zähler If Abfrage
 Die Auswertung der Bedingung erfolgt in dieser Wiederholungsschleife erst nach der Ausführung des Schleifenkörpers. Bei der Ausführung der Aktivität in der Schleife kann man ohne weiteren Logik nicht feststellen, ob es die erste Ausführung ist oder wiederholte. Ist das eine wiederholte Ausführung, so muss die Aktivierung des Zweigs von der Bedingung zur Aktivität signalisiert werde. 
 
 Die entsprechende Überprüfung kann mit Hilfe eines Zählers, der bei jedem Schleifendurchlauf hochgezählt wird, und einer if-Abfrage realisiert werden.
 
  
   
\subsection{Link Abdeckung}
Es geht bei dieser Metrik um Links mit einer \textit{transition condition}, die nicht mit einem konstante Wert \textit{true} oder \textit{false} belegt ist.  Das Link-Konzept von BPEL ist sehr mächtig und komplex. Durch  \textit{transition} und \textit{join condition} und das Attribut \textit{suppressJoin}  können komplizierten Bedingungen aufgestellt und damit der Kontrollfluß beeinflusst. Die BPEL-Spezifikation definiert die Auswertung dieser Bedingungen genau. Das Ziel diser Metrik ist, den Tester dazu zu bewegen, dass die \textit{transition condition} während der Tests mindestens einmal auf \textit{true} und einmal auf \textit{false} gesetzt wird. 

Für die Erfassung dieser Werte während der Ausführung werden ebenfalls Links verwendet. Folgende Aspekte müssen bei der Realisierung beachtete werden:
\begin{itemize}
	\item boundary-crossing Restriktionen
	\item unterschiedliche Wertebelegung der \textit{suppressJoin}-Variable und daraus resultierendes Verhalten beim Auftreten von \textit{JoinFailure}
	\item textit{Dead-Path-Elimination}
\end{itemize}
 

Es geht insbesondere darum, dass bei den Links sowohl der Status \textit{true} als auch \textit{false} erfasst werden müssen. Es werden drei verschiedene Ansätze mit ihren Vor- und Nachteilen vorgestellt. Das Beispiel aus der folgenden Abbildung dient als Grundlage für die Erläuterung. 
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/FlowBeispiel.png}
%	\label{fig:FlowBeispiel}
%\end{figure}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.40\textwidth]{bilder/FlowBeispielDesigner.png}
	\label{fig:FlowBeispielDesigner}
\end{figure}


\underline{Variante 1.}\\
Zwei zusätzliche Links werden definiert (\textit{LinkACopy} und \textit{LinkACopyNegiert}). Dabei übernimmt der \textit{LinkACopyNegiert} die negierte  transitionCondition des Originallinks und  der \textit{LinkACopy} die unveränderte. Die Logging-Anweisungen werden bei diesem Ansatz direkt in der flow-Umgebung platziert. Die source- und target-Aktivitäten können sich dabei beliebig tief in strukturierten Aktivitäten befinden. Durch die am Anfang definierten Links, wird die Quellaktivität des Originallinks mit den Logging-Anweisungen verlinkt. Für eine Logging-Anweisung ein Link. Sobald der Status der Links bekannt ist, wird eine Logging-Anweisung ausgeführt.

Die \textit{Default-JoinCondition} der Logging-Aktivitäten (\textit{or}-Verknüpfung von Status aller eingehenden Links) und die gegenseitig negierten \textit{transitionCondition} garantieren, dass nur eine Logginganweisung gleichzeitig ausgeführt werden kann.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz1.png}
%	\label{fig:LinksAnsatz1}
%\end{figure}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/LinksAnsatz1Designer.png}
	\label{fig:LinksAnsatz1Designer}
\end{figure}


\begin{table}[h!]
\begin{tabular}{p{6cm}p{0.5cm}p{6cm}}
\textbf{Vorteile}&\ &\textbf{Nachteile}\\[0.1cm]
\hline \\
Logging kann stattfinden, unabhängig davon, ob Activity2 ausgeführt wird&\ &\textit{boundary-crossing}-Restriktionen können verletzt werden\\
\end{tabular}
%\caption{Vergleich der Ansätze}
\label{Vergleichstabelle}
\end{table} 
  Dadurch sind sie bereit für die Ausführung, sobald die Ausführung der flow-Aktivität startet.
\FloatBarrier
\underline{Variante 2.}\\
Ziel dieses Ansatzes ist, die \textit{boundary-crossing}-Restriktionen einzuhalten.
Bei dieser Variante wird die Aktivität, die das Ziel eines oder mehreren Links ist in eine flow-Aktivität eingeschlossen. Durch die Platzierung der Anweisungen in derselben flow-Umgebung wird erreicht, dass die \textit{boundary-crossing}-Restriktionen durch die neu-hinzugefügten Links nicht verletzt werden können.
Die Konstruktion der neuen Links erfolgt nach derselben Schema (Varainte 1).  
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz2.png}
%	\label{fig:LinksAnsatz2}
%\end{figure}
\begin{figure}
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/LinksAnsatz2Designer.png}
	\label{fig:LinksAnsatz2Designer}
\end{figure}


\begin{table}[h!]
\begin{tabular}{p{6cm}p{0.5cm}p{6cm}}
\textbf{Vorteile}&\ &\textbf{Nachteile}\\[0.1cm]
\hline \\
\textit{boundary-crossing}-Restriktionen werden eingehalten&\ &Die Links können nur dann geloggt werden, wenn die Activity2 ausgeführt werden kann
\\
\end{tabular}
%\caption{Vergleich der Ansätze}
\label{Vergleichstabelle}
\end{table}
In der Tabelle werden die Vortele und Nachteile dieser Variante gegenübergestellt. 
Der Nachteil kommt zum Tragen, wenn Activity2 zum Beispiel in einem nicht aktiviertem Zweig der \textit{if}-Aktivität ist. Die Links können in dieser Situation bereits aktiviert sein und könnten damit registriert werden.
\FloatBarrier
\underline{Variante3.}\\
Bei dieser Variante wird die Sourceaktivität des Links durch eine \textit{flow}-Umgebung umschlossen. Einerseits sorgt die Platzierung der Logging-Anweisungen in derselben \textit{flow}-Umgebung für die Einhaltung der \textit{boundary-crossing}-Restriktionen. Andererseits kann das Logging auch stattfinden, wenn die Zielaktivität nicht ausgeführt wird. Da der Status der Links normalerweise nach der Ausführung der Quellaktivität erfolgt, sind die Logging-Aktivitäten zu diesem Zeitpunkt startbereit und können gleich nach dem Setzen des Status ihre Aufgabe ausführen.
%\begin{figure}[htbp]
%	\centering
%		\includegraphics{bilder/LinksAnsatz3.png}
%	\label{fig:LinksAnsatz3}
%\end{figure}
\begin{figure}[htbp]
	\centering
		\includegraphics[width=0.9\textwidth]{bilder/LinksAnsatz3Designer.png}
	\label{fig:LinksAnsatz3Designer}
\end{figure}


In einer Situation funktioniert auch diese Variante nicht. Befindet sich die Quellaktivität zum Beispiel in einem Zweig einer \textit{If}-Aktivität, so kann es vorkommen, dass dieser Zweig nicht aktiviert wird. Die Logging-Aktivitäten können in dieser Konstellation genauso wie die Quellaktivität nicht ausgeführt werden. Damit kann die Propagation des \textit{false}-Status auf allen ausgehenden Links nicht registriert werden.

\begin{table}[h!]
\begin{tabular}{p{6cm}p{0.5cm}p{6cm}}
\textbf{Vorteile}&\ &\textbf{Nachteile}\\[0.1cm]
\hline \\
\textit{boundary-crossing}-Restriktionen werden eingehalten&\ &
\\
Logging kann stattfinden, unabhängig davon, ob Activity2 ausgeführt wird&\ &
\\
\end{tabular}
%\caption{Vergleich der Ansätze}
\label{Vergleichstabelle}
\end{table} 

Als Lösung für die Abdeckungsmessung der Links eignet sich diese Variante am Besten. 

\subsection{Fault und Compensation Handler}
Für die Fault und Compensation Handler werden die Marken auf dieselbe Weise (mit Hilfe einer umschließenden sequence-Aktivität) in den catch und catchAll-Blöcken bzw. in Compensation Handler platziert. Vor der Platzierung der Marken müssen allerdings die so genannten inline-Handler durch explizite Scopes mit expliziten Fault und Compensation Hanler ersetzt werden (siehe Abbildung \ref{}).
 
\subsection{Realisierung der Kommunikation mit Web Service}
Mit Hilfe von Invoke-Aktivitäten kann ein BPEL-Prozess mit einem Web Service kommunizieren. Die invoke-Aktivität hat folgende Attributen:
\begin{itemize}
	\item \textbf{partnerLink} enthält des Partner Links. 
\item \textbf{portType} gibt WSDL-Porttype des Zielservices an.
\item \textbf{operation} gibt die WSDL-Operation an.
\item \textbf{inputVariable} gibt Variable an, die die zu sendenden Daten enthält.
\item \textbf{outputVariable} gibt Variable an, die die Antwort des Services speichert.
\end{itemize}

Soll eine asynchrone Kommunikation realisiert werden oder eine Operation aufgerufen werden, die keine Rückgabedaten erzeugt, so wird der Attribut \textit{outputVariable} weggelassen. Die Listing \ref{} zeigt eine invoke-Aktivität, die die Marken an den Service transportiert.

Zuvor muss die Variable .. natürlich deklariert werden. Damit die Variable im ganzen Prozess benutzt werden kann, wird sie als globale Variable (im \textit{variables}-Element des Prozesses) definiert. Zur Vermeidung der Namenskonflikten werden kryptische namen generiert.

Bild...

Die Zuordnung der Marken erfolgt mit Hilfe einer assign-Aktivität(siehe Listing \ref{} ).

Bild... 
   
Da in BPEL durch flow-Aktivität die nebenläufige Ausführung der Aktivitäten möglich ist,    
 Variable für jeden parallelen Zweig
\section{Auswertung der Daten und Ermittlung der Metriken}
Beim Instrumentieren des BPEL-Prozesses werden Marken generiert, die die entsprechenden Aspekte des Kontrollflusses eindeutig identifizieren und zu einer bestimmten Metrik gehören. Alle Marken, die in den Kontrollfluß eingefügt wurden, werden gespeichert und stehen während und nach der Ausführung des Prozesses zur Verfügung.
Während der BPEL-Prozess zum Testen ausgeführt wird, werden die Marken an den Web Service gesendet. 
Die empfangenen Marken liegen auf dem Ausführungspfad und wurden damit durch die Tests abgedeckt. 
Anhand der bei der Instrumentierung gespeicherten und während der Ausführung gesammelten Daten können die Statistiken ermittelt werden. Dabei gibt es die Möglichkeit sowohl die Statistik einer ganzen Testsuite als auch der einzelnen Testcases zu ermitteln.